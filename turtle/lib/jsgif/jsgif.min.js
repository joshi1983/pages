/* 
Copyright (c) 2010-2014 Kevin Kwok <antimatter15@gmail.com>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
/**
 * This class lets you encode animated GIF files
 * Base class :  http://www.java2s.com/Code/Java/2D-Graphics-GUI/AnimatedGifEncoder.htm
 * @author Kevin Weiner (original Java version - kweiner@fmsware.com)
 * @author Thibault Imbert (AS3 version - bytearray.org)
 * @author Kevin Kwok (JavaScript version - https://github.com/antimatter15/jsgif)
 * @version 0.1 AS3 implementation
 */
GIFEncoder=function(){for(var t=0,r={};t<256;t++)r[t]=String.fromCharCode(t);function n(){this.bin=[]}n.prototype.getData=function(){for(var t="",e=this.bin.length,n=0;n<e;n++)t+=r[this.bin[n]];return t},n.prototype.writeByte=function(t){this.bin.push(t)},n.prototype.writeUTFBytes=function(t){for(var e=t.length,n=0;n<e;n++)this.writeByte(t.charCodeAt(n))};function i(){a=0,y=l=s=u=null,F=!(b=!1)}var f,c,a,o,u,s,l,w,y,e={},h=null,d=-1,B=0,v=!(n.prototype.writeBytes=function(t,e,n){for(var r=n||t.length,i=e||0;i<r;i++)this.writeByte(t[i])}),g=[],p=7,m=-1,b=!1,F=!0,E=!1,U=10,A="Generated by jsgif (https://github.com/antimatter15/jsgif/)",C=(e.setDelay=function(t){B=Math.round(t/10)},e.setDispose=function(t){0<=t&&(m=t)},e.setRepeat=function(t){0<=t&&(d=t)},e.setTransparent=function(t){h=t},e.setComment=function(t){A=t},e.addFrame=function(t,e){if(null===t||!v||null===o)throw new Error("Please call start method before calling addFrame");var n=!0;try{e?t instanceof ImageData?(u=t.data,sizeset&&f==t.width&&c==t.height||C(t.width,t.height)):t instanceof Uint8ClampedArray?t.length==f*c*4?u=t:(console.log("Please set the correct size: ImageData length mismatch"),n=!1):(console.log("Please provide correct input"),n=!1):(u=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,E||C(t.canvas.width,t.canvas.height)),T(),D(),F&&(Q(),R(),0<=d)&&j(),I(),""!==A&&L(),N(),F||R(),z(),F=!1}catch(t){n=!1}return n},e.download=function(t){var e;null===o||0==b?console.log("Please call start method and add frames and call finish method before calling download"):(t=void 0!==t?t.endsWith(".gif")?t:t+".gif":"download.gif",(e=document.createElement("a")).download=t,e.href=URL.createObjectURL(new Blob([new Uint8Array(o.bin)],{type:"image/gif"})),e.click())},e.finish=function(){if(!v)return!1;var e=!0;v=!1;try{o.writeByte(59),b=!0}catch(t){e=!1}return e},e.setFrameRate=function(t){15!=t&&(B=Math.round(100/t))},e.setQuality=function(t){U=t=t<1?1:t},e.setSize=function(t,e){v&&!F||((f=t)<1&&(f=320),(c=e)<1&&(c=240),E=!0)}),D=(e.start=function(){i();var e=!0;b=!1,o=new n;try{o.writeUTFBytes("GIF89a")}catch(t){e=!1}return v=e},e.cont=function(){i();return b=!1,o=new n,v=!0},function(){for(var t=s.length,e=t/3,n=(l=[],new NeuQuant(s,t,U)),r=(y=n.process(),0),i=0;i<e;i++){var o=n.map(255&s[r++],255&s[r++],255&s[r++]);g[o]=!0,l[i]=o}w=8,p=7,(s=null)!==h&&(a=P(h))}),P=function(t){if(null===y)return-1;for(var e=(16711680&t)>>16,n=(65280&t)>>8,r=255&t,i=0,o=16777216,a=y.length,f=0;f<a;){var c=e-(255&y[f++]),u=n-(255&y[f++]),s=r-(255&y[f]),c=c*c+u*u+s*s,u=f/3;g[u]&&c<o&&(o=c,i=u),f++}return i},T=function(){for(var t=f,e=c,n=(s=[],u),r=0,i=0;i<e;i++)for(var o=0;o<t;o++){var a=i*t*4+4*o;s[r++]=n[a],s[r++]=n[1+a],s[r++]=n[2+a]}},I=function(){var t,e;o.writeByte(33),o.writeByte(249),o.writeByte(4),e=null===h?t=0:(t=1,2),0<=m&&(e=7&m),o.writeByte(0|(e<<=2)|t),W(B),o.writeByte(a),o.writeByte(0)},L=function(){o.writeByte(33),o.writeByte(254),o.writeByte(A.length),o.writeUTFBytes(A),o.writeByte(0)},N=function(){o.writeByte(44),W(0),W(0),W(f),W(c),F?o.writeByte(0):o.writeByte(128|p)},Q=function(){W(f),W(c),o.writeByte(240|p),o.writeByte(0),o.writeByte(0)},j=function(){o.writeByte(33),o.writeByte(255),o.writeByte(11),o.writeUTFBytes("NETSCAPE2.0"),o.writeByte(3),o.writeByte(1),W(d),o.writeByte(0)},R=function(){o.writeBytes(y);for(var t=768-y.length,e=0;e<t;e++)o.writeByte(0)},W=function(t){o.writeByte(255&t),o.writeByte(t>>8&255)},z=function(){new LZWEncoder(f,c,l,w).encode(o)};e.stream=function(){return o},e.setProperties=function(t,e){v=t,F=e};return e},
/**
 * This class handles LZW encoding
 * Adapted from Jef Poskanzer's Java port by way of J. M. G. Elliott.
 * @author Kevin Weiner (original Java version - kweiner@fmsware.com)
 * @author Thibault Imbert (AS3 version - bytearray.org)
 * @author Kevin Kwok (JavaScript version - https://github.com/antimatter15/jsgif)
 * @version 0.1 AS3 implementation
 */
LZWEncoder=function(){function n(t,e){F[h++]=t,254<=h&&A(e)}function c(t){for(var e=0;e<t;++e)d[e]=-1}var i,o,a,f,e,r,u,s,l,w,y,h,t={},d=[],B=[],v=0,g=!1,p=0,m=0,b=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],F=[],E=t.LZWEncoder=function(t,e,n,r){i=t,o=e,a=n,f=Math.max(2,r)},U=t.compress=function(t,e){var n,r,i,o,a,f;for(g=!1,s=C(u=l=t),y=1+(w=1<<t-1),v=2+w,h=0,i=D(),a=0,n=5003;n<65536;n*=2)++a;a=8-a,c(5003),P(w,e);t:for(;-1!=(f=D());)if(d[r=f<<a^i]==(n=(f<<12)+i))i=B[r];else{if(0<=d[r]){o=5003-r,0===r&&(o=1);do{if((r-=o)<0&&(r+=5003),d[r]==n){i=B[r];continue t}}while(0<=d[r])}P(i,e),i=f,v<4096?(B[r]=v++,d[r]=n):(f=e,c(5003),v=2+w,g=!0,P(w,f))}P(i,e),P(y,e)},A=(t.encode=function(t){t.writeByte(f),e=i*o,r=0,U(f+1,t),t.writeByte(0)},function(t){0<h&&(t.writeByte(h),t.writeBytes(F,0,h),h=0)}),C=function(t){return(1<<t)-1},D=function(){return 0===e?-1:(--e,255&a[r++])},P=function(t,e){for(p&=b[m],0<m?p|=t<<m:p=t,m+=u;8<=m;)n(255&p,e),p>>=8,m-=8;if((s<v||g)&&(g?(s=C(u=l),g=!1):s=12==++u?4096:C(u)),t==y){for(;0<m;)n(255&p,e),p>>=8,m-=8;A(e)}};return E.apply(this,arguments),t},
/*
 * NeuQuant Neural-Net Quantization Algorithm
 * ------------------------------------------
 *
 * Copyright (c) 1994 Anthony Dekker
 *
 * NEUQUANT Neural-Net quantization algorithm by Anthony Dekker, 1994. See
 * "Kohonen neural networks for optimal colour quantization" in "Network:
 * Computation in Neural Systems" Vol. 5 (1994) pp 351-367. for a discussion of
 * the algorithm.
 *
 * Any party obtaining a copy of these files from the author, directly or
 * indirectly, is granted, free of charge, a full and unrestricted irrevocable,
 * world-wide, paid up, royalty-free, nonexclusive right and license to deal in
 * this software and documentation files (the "Software"), including without
 * limitation the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to permit persons who
 * receive copies from any such party to do so, with the only requirement being
 * that this copyright notice remain intact.
 */
/*
 * This class handles Neural-Net quantization algorithm
 * @author Kevin Weiner (original Java version - kweiner@fmsware.com)
 * @author Thibault Imbert (AS3 version - bytearray.org)
 * @author Kevin Kwok (JavaScript version - https://github.com/antimatter15/jsgif)
 * @version 0.1 AS3 implementation
 */
NeuQuant=function(){var P,T,I,L,N,t={},Q=256,w=1<<18,R=[],l=[],y=[],W=[],e=t.NeuQuant=function(t,e,n){var r,i;for(T=t,I=e,L=n,N=new Array(Q),r=0;r<Q;r++)N[r]=new Array(4),(i=N[r])[0]=i[1]=i[2]=(r<<12)/Q,y[r]=256,l[r]=0},j=(t.map=function(t,e,n){for(var r,i,o,a=1e3,f=-1,c=R[e],u=c-1;c<Q||0<=u;)c<Q&&(a<=(r=(o=N[c])[1]-e)?c=Q:(c++,r<0&&(r=-r),(r+=i=(i=o[0]-t)<0?-i:i)<a&&(r+=i=(i=o[2]-n)<0?-i:i)<a&&(a=r,f=o[3]))),0<=u&&(a<=(r=e-(o=N[u])[1])?u=-1:(u--,r<0&&(r=-r),(r+=i=(i=o[0]-t)<0?-i:i)<a&&(r+=i=(i=o[2]-n)<0?-i:i)<a&&(a=r,f=o[3])));return f},t.process=function(){var t,e,n,r,i,o,a,f,c,u,s,l,w,y;for(P=30+((L=I<1509?1:L)-1)/3,l=T,u=(s=(y=I)/(3*L))/100|(w=0),f=1024,(a=(o=2048)>>6)<=1&&(a=0),t=0;t<a;t++)W[t]=f*(256*(a*a-t*t)/(a*a));for(c=I<1509?3:I%499!=0?1497:I%491!=0?1473:I%487!=0?1461:1509,t=0;t<s;)if(n=(255&l[w+0])<<4,r=(255&l[w+1])<<4,i=(255&l[w+2])<<4,e=M(n,r,i),G(f,e,n,r,i),0!==a&&z(a,e,n,r,i),y<=(w+=c)&&(w-=I),++t%(u=0===u?1:u)==0)for(f-=f/P,(a=(o-=o/30)>>6)<=1&&(a=0),e=0;e<a;e++)W[e]=f*(256*(a*a-e*e)/(a*a));j();for(var h,d,B,v,g,p=0,m=0,b=0;b<Q;b++){for(B=(v=N[d=b])[1],h=b+1;h<Q;h++)(g=N[h])[1]<B&&(d=h,B=g[1]);if(g=N[d],b!=d&&(h=g[0],g[0]=v[0],v[0]=h,h=g[1],g[1]=v[1],v[1]=h,h=g[2],g[2]=v[2],v[2]=h,h=g[3],g[3]=v[3],v[3]=h),B!=p){for(R[p]=m+b>>1,h=p+1;h<B;h++)R[h]=b;p=B,m=b}}for(R[p]=m+255>>1,h=p+1;h<256;h++)R[h]=255;for(var F=[],E=new Array(Q),U=0;U<Q;U++)E[N[U][3]]=U;for(var A=0,C=0;C<Q;C++){var D=E[C];F[A++]=N[D][0],F[A++]=N[D][1],F[A++]=N[D][2]}return F},function(){for(var t=0;t<Q;t++)N[t][0]>>=4,N[t][1]>>=4,N[t][2]>>=4,N[t][3]=t}),z=function(t,e,n,r,i){var o,a,f,c,u,s,l=e-t;for(l<-1&&(l=-1),Q<(f=e+t)&&(f=Q),o=e+1,a=e-1,u=1;o<f||l<a;){if(c=W[u++],o<f){s=N[o++];try{s[0]-=c*(s[0]-n)/w,s[1]-=c*(s[1]-r)/w,s[2]-=c*(s[2]-i)/w}catch(t){}}if(l<a){s=N[a--];try{s[0]-=c*(s[0]-n)/w,s[1]-=c*(s[1]-r)/w,s[2]-=c*(s[2]-i)/w}catch(t){}}}},G=function(t,e,n,r,i){e=N[e];e[0]-=t*(e[0]-n)/1024,e[1]-=t*(e[1]-r)/1024,e[2]-=t*(e[2]-i)/1024},M=function(t,e,n){for(var r,i,o,a=~(1<<31),f=a,c=-1,u=c,s=0;s<Q;s++)(r=(o=N[s])[0]-t)<0&&(r=-r),(r=(r+=i=(i=o[1]-e)<0?-i:i)+(i=(i=o[2]-n)<0?-i:i))<a&&(a=r,c=s),(o=r-(l[s]>>12))<f&&(f=o,u=s),y[s]-=i=y[s]>>10,l[s]+=i<<10;return y[c]+=64,l[c]-=65536,u};return e.apply(this,arguments),t};