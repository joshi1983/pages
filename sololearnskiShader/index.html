<!doctype html>
<html lang="en">
	<head>
		<title>Sololearnski Shader</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="script.js"></script>
		<link rel="stylesheet" href="style.css">
		<script>
			// circles data for use in the Sololearnski Carpet fractal
			var circles = [{"cy": 118, "cx": 140, "radius": 71.31810730249998}, {"cy": 59, "cx": 257, "radius": 59.137767414999985}, {"cy": 223, "cx": 63, "radius": 57.665631459999986}, {"cy": 54, "cx": 356, "radius": 39}, {"cy": 315, "cx": 39, "radius": 37.41328313203772}, {"cy": 63, "cx": 418, "radius": 23.360679774999994}, {"cy": 374, "cx": 36, "radius": 21.652475842499996}, {"cy": 35, "cx": 181, "radius": 20.561667965685118}, {"cy": 147, "cx": 54, "radius": 18.865407994589944}, {"cy": 73, "cx": 455, "radius": 14.416407864999998}, {"cy": 203, "cx": 132, "radius": 14.057533251465998}, {"cy": 18, "cx": 317, "radius": 13.532721781096669}, {"cy": 125, "cx": 225, "radius": 13.416407864999998}, {"cy": 272, "cx": 12, "radius": 13}, {"cy": 408, "cx": 38, "radius": 11.944271909999998}, {"cy": 89, "cx": 320, "radius": 10.64045268267806}, {"cy": 289, "cx": 80, "radius": 10.488605385554962}, {"cy": 37, "cx": 150, "radius": 9.708203932499998}, {"cy": 16, "cx": 204, "radius": 9.111774708006237}, {"cy": 120, "cx": 60, "radius": 8.706888792470238}, {"cy": 80, "cx": 477, "radius": 8.670384896230393}, {"cy": 164, "cx": 33, "radius": 8.153104177622648}, {"cy": 37, "cx": 400, "radius": 7.472135954999999}, {"cy": 353, "cx": 16, "radius": 7.005181496987902}, {"cy": 82, "cx": 393, "radius": 7}, {"cy": 8, "cx": 299, "radius": 6.930379221635732}, {"cy": 355, "cx": 57, "radius": 6.4501412668848985}, {"cy": 427, "cx": 40, "radius": 6.236067977499999}, {"cy": 254, "cx": 6, "radius": 5.973665961010276}, {"cy": 60, "cx": 191, "radius": 5.915305156098526}, {"cy": 160, "cx": 75, "radius": 5.832770075866993}, {"cy": 14, "cx": 336, "radius": 5.721359549995796}, {"cy": 123, "cx": 244, "radius": 5.688565309542801}, {"cy": 195, "cx": 150, "radius": 5.64018235212621}, {"cy": 222, "cx": 127, "radius": 5.589349452922502}, {"cy": 141, "cx": 214, "radius": 5.472135955}, {"cy": 289, "cx": 5, "radius": 5.384776310850235}, {"cy": 41, "cx": 135, "radius": 5.236067977499999}, {"cy": 191, "cx": 117, "radius": 5.103787845900875}, {"cy": 8, "cx": 218, "radius": 5}, {"cy": 85, "cx": 490, "radius": 5}, {"cy": 109, "cx": 216, "radius": 4.941151885685821}, {"cy": 99, "cx": 307, "radius": 4.8934749593285005}, {"cy": 278, "cx": 92, "radius": 4.511534766839269}, {"cy": 107, "cx": 65, "radius": 4.484267330488919}, {"cy": 56, "cx": 445, "radius": 4.472135955}, {"cy": 92, "cx": 335, "radius": 4.416586692184822}, {"cy": 174, "cx": 25, "radius": 4.342432531709996}, {"cy": 304, "cx": 80, "radius": 4.236067977499999}, {"cy": 82, "cx": 438, "radius": 4.2255486732674505}, {"cy": 36, "cx": 316, "radius": 4.18679338095027}, {"cy": 29, "cx": 391, "radius": 4}, {"cy": 244, "cx": 5, "radius": 4}, {"cy": 4, "cx": 288, "radius": 3.9970090556584026}, {"cy": 396, "cx": 49, "radius": 3.9013888358612796}, {"cy": 26, "cx": 158, "radius": 3.8932665762354457}, {"cy": 397, "cx": 25, "radius": 3.8426217254639283}, {"cy": 275, "cx": 29, "radius": 3.8177731241388884}, {"cy": 74, "cx": 318, "radius": 3.6794276831576553}, {"cy": 344, "cx": 10, "radius": 3.5989101767820344}, {"cy": 284, "cx": 67, "radius": 3.4397828916291573}, {"cy": 13, "cx": 192, "radius": 3.2575421688467436}, {"cy": 44, "cx": 127, "radius": 3.2360679775}, {"cy": 125, "cx": 49, "radius": 3.2360679775}, {"cy": 437, "cx": 41, "radius": 3.2360679775}, {"cy": 46, "cx": 160, "radius": 3.144871216574277}, {"cy": 68, "cx": 195, "radius": 3.012236434092543}, {"cy": 232, "cx": 123, "radius": 3.0056137884700647}, {"cy": 148, "cx": 208, "radius": 3.005509401748199}, {"cy": 5, "cx": 226, "radius": 3}, {"cy": 13, "cx": 345, "radius": 3}, {"cy": 37, "cx": 411, "radius": 3}, {"cy": 85, "cx": 403, "radius": 3}, {"cy": 87, "cx": 382, "radius": 3}, {"cy": 88, "cx": 498, "radius": 3}, {"cy": 99, "cx": 68, "radius": 3}, {"cy": 122, "cx": 253, "radius": 3}, {"cy": 180, "cx": 20, "radius": 3}, {"cy": 347, "cx": 64, "radius": 3}, {"cy": 363, "cx": 14, "radius": 2.944271909997692}, {"cy": 190, "cx": 158, "radius": 2.8977939586179104}, {"cy": 153, "cx": 32, "radius": 2.892256839564613}, {"cy": 297, "cx": 3, "radius": 2.835940462958497}, {"cy": 165, "cx": 82, "radius": 2.769555191175634}, {"cy": 186, "cx": 111, "radius": 2.6075310106049017}, {"cy": 47, "cx": 397, "radius": 2.5932686861708447}, {"cy": 273, "cx": 97, "radius": 2.559533045026207}, {"cy": 130, "cx": 67, "radius": 2.535526564442751}, {"cy": 28, "cx": 203, "radius": 2.525124795545274}, {"cy": 364, "cx": 58, "radius": 2.5136161046891488}, {"cy": 70, "cx": 472, "radius": 2.5099549912685557}, {"cy": 85, "cx": 467, "radius": 2.5099549912685557}, {"cy": 102, "cx": 212, "radius": 2.4382483558431147}, {"cy": 166, "cx": 44, "radius": 2.417644083199221}, {"cy": 103, "cx": 300, "radius": 2.384586246088112}, {"cy": 58, "cx": 183, "radius": 2.330906095136795}, {"cy": 5, "cx": 308, "radius": 2.2786665197452276}, {"cy": 72, "cx": 394, "radius": 2.2713314609525987}, {"cy": 2, "cx": 280, "radius": 2.2360679775}, {"cy": 93, "cx": 342, "radius": 2.2360679775}, {"cy": 53, "cx": 196, "radius": 2.156604267887836}, {"cy": 9, "cx": 330, "radius": 2.088890125910858}, {"cy": 7, "cx": 211, "radius": 2.0710678118654755}, {"cy": 352, "cx": 25, "radius": 2.0502036411495155}, {"cy": 152, "cx": 75, "radius": 2.0371924378732444}, {"cy": 237, "cx": 5, "radius": 2.000104100705208}, {"cy": 3, "cx": 231, "radius": 2}, {"cy": 13, "cx": 350, "radius": 2.0}, {"cy": 24, "cx": 384, "radius": 2}, {"cy": 46, "cx": 122, "radius": 2}, {"cy": 50, "cx": 440, "radius": 2}, {"cy": 56, "cx": 452, "radius": 2}, {"cy": 85, "cx": 431, "radius": 2}, {"cy": 121, "cx": 258, "radius": 2}, {"cy": 130, "cx": 240, "radius": 2}, {"cy": 185, "cx": 17, "radius": 2}, {"cy": 219, "cx": 134, "radius": 2}, {"cy": 237, "cx": 121, "radius": 2}, {"cy": 269, "cx": 101, "radius": 2}, {"cy": 285, "cx": 92, "radius": 2}, {"cy": 311, "cx": 79, "radius": 2}, {"cy": 339, "cx": 7, "radius": 2}, {"cy": 343, "cx": 67, "radius": 2.0}, {"cy": 420, "cx": 46, "radius": 2}, {"cy": 421, "cx": 32, "radius": 2}];
		</script>
	</head>
	<body>
		<script type="glsl/vertex">
  attribute vec2 coords;
  
  void main(void) {
    gl_Position = vec4(coords.xy, 0.0, 1.0);
  }
</script>
<script type="glsl/fragment">
// <![CDATA[
precision mediump float;

uniform float circles[6 * 125];
uniform vec2 centre;
uniform float scale;
uniform vec2 cutOffs;

vec3 getCircleInLeaf(vec2 p) {
	for (int i = 0; i < 375; i += 3) {
		vec3 c = vec3(circles[i], circles[i + 1], circles[i + 2]);
		vec2 delta = c.xy - p;
		float lenSquared = delta.x * delta.x + delta.y * delta.y;
		if (lenSquared < c.z) {
			return vec3(delta.x, delta.y, c.z);
		}
	}
	return vec3(0.0, 0.0, -1.0);
}

bool isLenSquaredInRange(float lenSquared) {
	return lenSquared <= 1.0 && lenSquared > 0.16;
}

vec3 getCircleInSololearnski(vec3 p) {
	vec2 p2 = p.xy / p.z;
	float lenSquared = p.x * p.x + p.y * p.y;
	if (!isLenSquaredInRange(lenSquared))
		return vec3(0.0, 0.0, -1.0);

	float a = atan(p2.x, p2.y);
	// what angle should be checked?
	a += lenSquared * 1.48;
	// if angle is negative, add 2 pi radiens( full rotation ) to make it positive. 
	if (a < 0.0) {
		a += 6.283185307179586476925286766559;
	}
	float rotationAngle = float(int(a * 0.954929658551372) - 2) * 1.0471975511966;
	float sinA = sin(rotationAngle);
	float cosA = cos(rotationAngle);
	p2 = vec2(p2.x * cosA - p2.y * sinA, p2.y * cosA + p2.x * sinA);
	vec3 result = getCircleInLeaf(p2);
	if (result.z > 0.0)
		return result;

	// if part of the pattern might be in a neighbouring slice, check it too.
	if (lenSquared < 0.27) {
		// rotate by 1/3 of PI.
		cosA = 0.5;
		sinA = -0.8660254037844398;
		p2 = vec2(p2.x * cosA - p2.y * sinA, p2.y * cosA + p2.x * sinA);
		result = getCircleInLeaf(p2);
		if (result.z > 0.0) {
			return result;
		}
	}
	return result;
}

float getValueAt(vec2 p) {
	vec3 result = getCircleInSololearnski(vec3(p.x, p.y, 1.0));
	float scaleFactor = 1.0;
	if (result.z > 0.0) {
		float z = sqrt(result.z);
		result.x /= z;
		result.y /= z;
		for (int i = 0; i < 10; i++) {
			vec3 newP = vec3(result.x, result.y, 1.0);
			result = getCircleInSololearnski(newP);
			scaleFactor *= result.z;
			if (result.z <= 0.0)
				return 0.0;
			
			z = sqrt(result.z);
			if (scaleFactor * z < cutOffs.x)
				return 1.0;
			result.x /= z;
			result.y /= z;
			if (scaleFactor * z < cutOffs.y) {
				// very tiny circle so just check if length is in range.
				float lenSquared = result.x * result.x + result.y * result.y;
				if (isLenSquaredInRange(lenSquared))
					return 1.0;
				else
					return 0.0;
			}
		}
		return 1.0;
	}
	else
		return 0.0;
}

void main(void) {
	vec2 p = (gl_FragCoord.xy - centre) * scale;
	float val = getValueAt(p);
	gl_FragColor = vec4(val, val, val, 1.0);
}
// ]]>
</script>

		<canvas></canvas>
		
		<div id="dialog">
			<p>This is a WebGL shader for the Sololearnski Carpet Fractal.</p>
			<ul>
				<li><a href="https://www.youtube.com/watch?v=6oTEzDDTsnU" target="_empty">Sololearnski Fractal - zoom video</a></li>
				<li><a href="https://code.sololearn.com/WVhoMHzy3K81" target="_empty">Interactive Sololearnski Fractal Viewer</a></li>
			</ul>
			<footer>
				<button id="ok-button">OK</button>
			</footer>
		</div>
	</body>
</html>